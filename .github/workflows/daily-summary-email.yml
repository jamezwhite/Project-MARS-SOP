name: Daily layman summary email

on:
  # GitHub Actions uses UTC for schedules.
  # Run daily at 08:30 UTC.
  schedule:
    - cron: '30 8 * * *'
  # Manual trigger for testing
  workflow_dispatch: {}

jobs:
  daily-summary:
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      HAS_CHANGES: "false"

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect commits from last 24 hours
        id: collect
        run: |
          git log --since="24 hours ago" --date=short \
            --pretty=format:'Commit %h (%ad) by %an%n%s%n%b%n---%n' \
            > daily_commits.txt

          if [ ! -s daily_commits.txt ]; then
            echo "No commits in last 24 hours."
            echo "HAS_CHANGES=false" >> "$GITHUB_ENV"
          else
            echo "Found commits in last 24 hours."
            echo "HAS_CHANGES=true" >> "$GITHUB_ENV"
          fi

      - name: Generate AI summary (gpt-5-mini)
        if: env.HAS_CHANGES == 'true'
        id: ai_summary
        run: |
          SYSTEM_PROMPT=$'You are an expert technical communicator. Your job is to explain work to non-technical stakeholders in clear, friendly language.\nYou will be given a list of git commits from the last 24 hours.'
          LOG_CONTENT=$(cat daily_commits.txt)
          USER_PROMPT=$'Summarize, in 3–5 plain-language bullet points, what was accomplished in the last 24 hours in this project.\nWrite for a layperson (for example, a manager or stakeholder with no technical background).\nFocus on the big-picture document changes and why they matter (structure clarified, sections added, explanations improved).\nDo not list individual commits or files. Do not use jargon. Just give a short narrative summary in a bulleted list.\nHere are the raw commits:'

          JSON=$(jq -n \
            --arg sys "$SYSTEM_PROMPT" \
            --arg user "$USER_PROMPT" \
            --arg log "$LOG_CONTENT" \
            '{
              "model": "gpt-5-mini",
              "messages": [
                {"role": "system", "content": $sys},
                {"role": "user", "content": ($user + "\n\n" + $log)}
              ]
            }')

          RESPONSE=$(echo "$JSON" | curl -sS https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer ${OPENAI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @-)

          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$SUMMARY" ] || [ "$SUMMARY" = "null" ]; then
            echo "Summary generation failed:"
            echo "$RESPONSE"
            exit 1
          fi

          echo "Generated summary:"
          echo "------------------"
          echo "$SUMMARY"
          echo "------------------"

          {
            echo "summary<<EOF"
            echo "$SUMMARY"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Send daily email
        if: env.HAS_CHANGES == 'true'
        uses: dawidd6/action-send-mail@v6
        with:
          # Your SMTP server details
          server_address: mail.spacemail.com
          server_port: 465
          secure: true

          # Auth (put these in GitHub secrets)
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}

          # Email metadata
          subject: "Daily project summary – ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO_PERSONALEMAIL }}
          from: ${{ secrets.MAIL_FROM }}

          # Body is the AI-generated summary
          body: ${{ steps.ai_summary.outputs.summary }}
